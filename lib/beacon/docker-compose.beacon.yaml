version: '3.7'

services:

  beacon:
    image: ${BEACON_IMAGE}:${BEACON_VERSION}
    container_name: ${BEACON_CONTAINER_NAME}
    environment: 
      - BEACON_DEBUG=${BEACON_DEBUG}
      - GOHAN_BASE_URL=${BEACON_GOHAN_BASE_URL}
      - KATSU_TIMEOUT=${BEACON_KATSU_TIMEOUT}
      - KATSU_BASE_URL=http://${BENTOV2_KATSU_CONTAINER_NAME}:${BENTOV2_KATSU_INTERNAL_PORT}
      - GOHAN_TIMEOUT=${BEACON_GOHAN_TIMEOUT}
      - BEACON_INTERNAL_PORT=${BEACON_INTERNAL_PORT}
      - BEACON_EXTERNAL_PORT=${BEACON_EXTERNAL_PORT}
      - BEACON_DEBUGGER_INTERNAL_PORT=${BEACON_DEBUGGER_INTERNAL_PORT}
      - BEACON_DEBUGGER_EXTERNAL_PORT=${BEACON_DEBUGGER_EXTERNAL_PORT}
      - CONFIG_ABSOLUTE_PATH=/config/
      - BEACON_SMALL_CELL_COUNT_THRESHOLD=${BEACON_SMALL_CELL_COUNT_THRESHOLD}
      - BEACON_MAX_FILTERS=${BEACON_MAX_FILTERS}
      - ENABLE_AUTHX=${ENABLE_AUTHX}
      - OIDC_ISSUER=${BENTOV2_AUTH_PUBLIC_URL}/auth/realms/${BENTOV2_AUTH_REALM}
      - CLIENT_ID=${BENTOV2_AUTH_CLIENT_ID}
    volumes:
      - ./config:/config
    networks: 
      - bridge-net
    expose:
      - ${BEACON_INTERNAL_PORT}
    mem_limit: ${BEACON_MEM_LIM} # for mem_limit to work, make sure docker-compose is v2.4
    cpus: ${BEACON_CPUS}
    cpu_shares: 512
    healthcheck:
      test: [ "CMD", "curl", "http://localhost:${BEACON_INTERNAL_PORT}" ]
      timeout: ${BENTOV2_HEALTHCHECK_TIMEOUT}
      interval: ${BENTOV2_HEALTHCHECK_INTERVAL}
      retries: ${BENTOV2_HEALTHCHECK_RETRIES}

