services:

  beacon:
    image: ${BENTO_BEACON_IMAGE}:${BENTO_BEACON_VERSION}
    container_name: ${BENTO_BEACON_CONTAINER_NAME}
    environment:
      - BENTO_BEACON_DEBUG=${BENTO_BEACON_DEBUG}
      - GOHAN_BASE_URL=${BENTO_BEACON_GOHAN_BASE_URL}
      - KATSU_TIMEOUT=${BENTO_BEACON_KATSU_TIMEOUT}
      - KATSU_BASE_URL=http://${BENTOV2_KATSU_CONTAINER_NAME}:${BENTOV2_KATSU_INTERNAL_PORT}
      - GOHAN_TIMEOUT=${BENTO_BEACON_GOHAN_TIMEOUT}
      - BENTO_BEACON_INTERNAL_PORT=${BENTO_BEACON_INTERNAL_PORT}
      - BENTO_BEACON_EXTERNAL_PORT=${BENTO_BEACON_EXTERNAL_PORT}
      - BENTO_BEACON_DEBUGGER_INTERNAL_PORT=${BENTO_BEACON_DEBUGGER_INTERNAL_PORT}
      - BENTO_BEACON_DEBUGGER_EXTERNAL_PORT=${BENTO_BEACON_DEBUGGER_EXTERNAL_PORT}
      - CONFIG_ABSOLUTE_PATH=/config/
      - BEACON_SMALL_CELL_COUNT_THRESHOLD=${BENTO_BEACON_SMALL_CELL_COUNT_THRESHOLD}
      - BEACON_MAX_FILTERS=${BENTO_BEACON_MAX_FILTERS}
    volumes:
      - ./config:/config:ro
    networks: 
      - beacon-net
    expose:
      - ${BENTO_BEACON_INTERNAL_PORT}
    mem_limit: ${BENTO_BEACON_MEM_LIM} # for mem_limit to work, make sure docker-compose is v2.4
    cpus: ${BENTO_BEACON_CPUS}
    cpu_shares: 512
    healthcheck:
      test: [ "CMD", "curl", "http://localhost:${BENTO_BEACON_INTERNAL_PORT}/service-info" ]
      timeout: ${BENTOV2_HEALTHCHECK_TIMEOUT}
      interval: ${BENTOV2_HEALTHCHECK_INTERVAL}

networks:
  beacon-net:
    external: true
    name: ${BENTO_BEACON_NETWORK}
